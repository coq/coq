dist: trusty

# Travis builds are slower using sudo: false (the container-based
# infrastructure) as of March 2017; see
# https://github.com/coq/coq/pull/467 for some discussion.
sudo: required

# Until Ocaml becomes a language, we set a known one.
language: c

cache:
  apt: true
  directories:
  - $HOME/.opam

before_cache:
  - rm -rf ~/.opam/log/

addons:
  apt:
    sources:
    - avsm
    packages:
    - opam
    - aspcud
    - gcc-multilib

env:
  global:
  - NJOBS=2
  # system is == 4.02.3
  - COMPILER="system"
  - CAMLP5_VER="6.14"
  - NATIVE_COMP="yes"
  # Main test suites

matrix:

  allow_failures:
  - env: TEST_TARGET="ci-coq-dpdgraph" EXTRA_OPAM="ocamlgraph"
  - env: TEST_TARGET="ci-geocoq"
  - env: TEST_TARGET="ci-fiat-parsers"

  include:
    - env:
      - TEST_TARGET="install"
      - EXTRA_CONF="-coqide opt"
      - EXTRA_OPAM="lablgtk-extras"
      script: dev/ci/build.sh
      stage: build
      addons:
        apt: &coqide-apt
          sources:
          - avsm
          packages:
          - opam
          - aspcud
          - libgtk2.0-dev
          - libgtksourceview2.0-dev

    - env:
      - TEST_TARGET="install"
      - COMPILER="4.02.3+32bit"
      script: dev/ci/build.sh
      stage: build

    - env:
      - TEST_TARGET="install"
      - COMPILER="4.04.1"
      - CAMLP5_VER="6.17"
      - EXTRA_CONF="-coqide opt"
      - EXTRA_OPAM="lablgtk-extras"
      script: dev/ci/build.sh
      stage: build
      addons:
        apt: *coqide-apt

    - env: TEST_TARGET="test-suite"
      script: dev/ci/test-suite.sh
      stage: test
    - env: TEST_TARGET="test-suite" COMPILER="4.02.3+32bit"
      script: dev/ci/test-suite.sh
    - env: TEST_TARGET="test-suite" COMPILER="4.04.1" CAMLP5_VER="6.17"
      script: dev/ci/test-suite.sh

    - env: TEST_TARGET="validate"                             TW="travis_wait"
      script: dev/ci/validate.sh
    - env: TEST_TARGET="validate"   COMPILER="4.02.3+32bit"   TW="travis_wait"
      script: dev/ci/validate.sh

    - env: TEST_TARGET="ci-bignums"
    - env: TEST_TARGET="ci-color"
    - env: TEST_TARGET="ci-compcert"
    - env: TEST_TARGET="ci-coq-dpdgraph" EXTRA_OPAM="ocamlgraph"
    - env: TEST_TARGET="ci-coquelicot"
    - env: TEST_TARGET="ci-geocoq"
    - env: TEST_TARGET="ci-fiat-crypto"
    - env: TEST_TARGET="ci-fiat-parsers"
    - env: TEST_TARGET="ci-flocq"
    - env: TEST_TARGET="ci-formal-topology"
    - env: TEST_TARGET="ci-hott"
    - env: TEST_TARGET="ci-iris-coq"
    - env: TEST_TARGET="ci-math-classes"
    - env: TEST_TARGET="ci-math-comp"
    - env: TEST_TARGET="ci-sf"
    - env: TEST_TARGET="ci-unimath"
    - env: TEST_TARGET="ci-vst"
      # Not ready yet for 8.7
      # - TEST_TARGET="ci-cpdt"
      # - TEST_TARGET="ci-metacoq"
      # - TEST_TARGET="ci-tlc"

    - env:
      - TEST_TARGET="documentation"
      - EXTRA_OPAM="hevea"
      script: dev/ci/documentation.sh
      addons:
        apt: &extra-apt
          sources:
          - avsm
          packages:
          - opam
          - aspcud
          - libgtk2.0-dev
          - libgtksourceview2.0-dev
          - texlive-latex-base
          - texlive-latex-recommended
          - texlive-latex-extra
          - texlive-math-extra
          - texlive-fonts-recommended
          - texlive-fonts-extra
          - latex-xcolor
          - ghostscript
          - transfig
          - imagemagick
          - tipa

    - env:
      - TEST_TARGET="documentation"
      - COMPILER="4.04.1"
      - CAMLP5_VER="6.17"
      - EXTRA_OPAM="hevea"
      script: dev/ci/documentation.sh
      addons:
        apt: *extra-apt

    # Ocaml warnings with two compilers
    - env:
      - TEST_TARGET="coqocaml"
      - EXTRA_CONF="-coqide opt -warn-error"
      - EXTRA_OPAM="lablgtk-extras"
      # dummy target
      - BUILD_TARGET="clean"
      script: dev/ci/warnings.sh
      addons:
        apt: *coqide-apt

    - env:
      - TEST_TARGET="coqocaml"
      - COMPILER="4.04.1"
      - CAMLP5_VER="6.17"
      - EXTRA_CONF="-coqide opt -warn-error"
      - EXTRA_OPAM="lablgtk-extras"
      # dummy target
      - BUILD_TARGET="clean"
      script: dev/ci/warnings.sh
      addons:
        apt: *coqide-apt

    - os: osx
      env:
      - TEST_TARGET="test-suite"
      - COMPILER="system"
      - CAMLP5_VER="6.17"
      - NATIVE_COMP="no"
      # disable mega on osx
      - MEGANAME=""
      - MEGAPASS=""
      script: dev/ci/test-suite.sh
      before_install:
      - brew update
      - brew install opam

install: dev/ci/setup.sh

script:
- ${TW} dev/ci/contrib.sh

# Testing Gitter webhook
notifications:
  webhooks:
    urls:
      - https://webhooks.gitter.im/e/3cdabdec318214c7cd63
    on_success: change  # options: [always|never|change] default: always
    on_failure: always  # options: [always|never|change] default: always
    on_start: never     # options: [always|never|change] default: always
