(executable
 (name gen_sphinx_install)
 (modules gen_sphinx_install))

(rule
 (targets dune-install)
 ; (deps (:include dune-files))
 (mode promote)
 (deps
   sphinx_build)
  ; We could use finer dependencies here.
  ; theories/*/.vo <- generated by dune
  ; config/coq_config.py
  ; tools/coqdoc/coqdoc.css
  ; @rgrinberg mentions that this should be supported.
  ; %{bin:coqdoc}
  ; Must find a solution for the _static folder
  ; doc/sphinx/_static/
  ; (package coq)
  ; (source_tree sphinx)
  ; (source_tree tools))
 (action (with-stdout-to dune-install (run ./gen_sphinx_install.exe))))

(rule
 (targets sphinx_build)
 (deps
  ; We could use finer dependencies here so the build is faster:
  ;
  ; - vo files: generated by sphinx after parsing the doc, promoted,
  ; - Static files:
  ;   + %{bin:coqdoc} etc...
  ;   + config/coq_config.py
  ;   + tools/coqdoc/coqdoc.css
  (package coq)
  (source_tree sphinx)
  (source_tree tools))
 (action (run sphinx-build -j4 -b html -d sphinx_build/doctrees sphinx sphinx_build/html)))

(alias
 (name refman-html)
 (deps sphinx_build))

; The install target still needs more work.
; (install
;  (section doc)
;  (package coq-refman)
;  (files sphinx_build))
