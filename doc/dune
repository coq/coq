(rule
 (targets unreleased.rst)
 (deps (source_tree changelog))
 (action (with-stdout-to %{targets} (bash "cat changelog/00-title.rst changelog/*/*.rst"))))

(alias
 (name refman-deps)
 (deps
  ; We could use finer dependencies here so the build is faster:
  ;
  ; - vo files: generated by sphinx after parsing the doc, promoted,
  ; - Static files:
  ;   + %{bin:coqdoc} etc...
  ;   + config/coq_config.py
  ;   + tools/coqdoc/coqdoc.css
  (package rocq-runtime)
  (package coq-core)
  (package rocq-core)
  (source_tree sphinx)
  (source_tree tools/coqrst)
  unreleased.rst
  (env_var SPHINXWARNOPT)
  (env_var COQRST_EXTRA)))

(rule
 (targets
  (dir refman-html))
 (alias refman-html)
 (package coq-doc)
 ; Cannot use this deps alias because of ocaml/dune#3415
 ; (deps (alias refman-deps))
 ; EJGA: note this should've been fixed in dune master as of 05/03/2021
 (deps
  (package rocq-runtime)
  (package coq-core)
  (package rocq-core)
  (source_tree sphinx)
  (source_tree tools/coqrst)
  ../config/coq_config.py
  unreleased.rst
  (env_var SPHINXWARNOPT)
  (env_var COQRST_EXTRA))
 (action
  (run env sphinx-build -q %{env:SPHINXWARNOPT=-W} -b html sphinx %{targets})))

(rule
 (targets
  (dir refman-pdf))
 (alias refman-pdf)
 (package coq-doc)
 ; Cannot use this deps alias because of ocaml/dune#3415
 ; (deps (alias refman-deps))
 ; EJGA: note this should've been fixed in dune master as of 05/03/2021
 (deps
  (package rocq-runtime)
  (package coq-core)
  (package rocq-core)
  (source_tree sphinx)
  (source_tree tools/coqrst)
  ../config/coq_config.py
  unreleased.rst
  (env_var SPHINXWARNOPT)
  (env_var COQRST_EXTRA))
 (action
  (progn
   (run env sphinx-build -q %{env:SPHINXWARNOPT=-W} -b latex sphinx %{targets})
   (chdir %{targets} (run make LATEXMKOPTS=-silent)))))

(install
 (dirs
  (refman-html as html/refman)
  (refman-pdf as pdf/refman))
 (section doc)
 (package coq-doc))

(documentation
 (package coq-doc))
