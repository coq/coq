image: "$IMAGE"

stages:
  - docker
  - stage-1 # No dependencies

# When a job has no dependencies, it goes to stage 1.  Otherwise, we
# set both "needs" and "dependencies". "needs" is a superset of
# "dependencies" that should include all the transitive dependencies.
# "dependencies" only list the previous jobs whose artifact we need to
# keep.

# some default values
variables:
  # Format: $IMAGE-V$DATE [Cache is not used as of today but kept here
  # for reference]
  CACHEKEY: "bionic_coq-V2020-07-21-V38"
  IMAGE: "$CI_REGISTRY_IMAGE:$CACHEKEY"
  # By default, jobs run in the base switch; override to select another switch
  OPAM_SWITCH: "base"
  # Used to select special compiler switches such as flambda, 32bits, etc...
  OPAM_VARIANT: ""
  GIT_DEPTH: "10"

docker-boot:
  stage: docker
  image: docker:stable
  services:
    - docker:dind
  before_script: []
  script:
    - docker login -u gitlab-ci-token -p "$CI_JOB_TOKEN" "$CI_REGISTRY"
    - cd dev/ci/docker/bionic_coq/
    - if docker pull "$IMAGE"; then echo "Image prebuilt!"; exit 0; fi
    - docker build -t "$IMAGE" .
    - docker push "$IMAGE"
  except:
    variables:
      - $SKIP_DOCKER == "true"
      - $ONLY_WINDOWS == "true"
  tags:
    - docker

bench:
  stage: stage-1
  when: manual
  before_script:
    - printenv -0 | sort -z | tr '\0' '\n'
  script:
    - . ~/.opam/opam-init/init.sh
    - ./dev/bench/gitlab.sh
  tags:
    - timing
  variables:
    coq_pr_number: ""
    coq_pr_comment_id: ""
    new_ocaml_switch: "ocaml-base-compiler.4.07.1"
    old_ocaml_switch: "ocaml-base-compiler.4.07.1"
    new_coq_repository: "https://gitlab.com/coq/coq.git"
    old_coq_repository: "https://gitlab.com/coq/coq.git"
    new_coq_commit: "$CI_COMMIT_SHA"
    old_coq_commit: "master"
    new_coq_opam_archive_git_uri: "https://github.com/coq/opam-coq-archive.git"
    old_coq_opam_archive_git_uri: "https://github.com/coq/opam-coq-archive.git"
    new_coq_opam_archive_git_branch: "master"
    old_coq_opam_archive_git_branch: "master"
    num_of_iterations: 1
    coq_opam_packages: "coq-performance-tests coq-engine-bench coq-hott coq-bignums coq-mathcomp-ssreflect coq-mathcomp-fingroup coq-mathcomp-algebra coq-mathcomp-solvable coq-mathcomp-field coq-mathcomp-character coq-mathcomp-odd-order coq-math-classes coq-corn coq-flocq coq-compcert coq-geocoq coq-color coq-coqprime coq-coqutil coq-bedrock2 coq-rewriter coq-fiat-core coq-fiat-parsers coq-fiat-crypto coq-unimath coq-sf-plf coq-coquelicot coq-lambda-rust coq-verdi coq-verdi-raft coq-fourcolor coq-rewriter-perf-SuperFast"
  artifacts:
    name: "$CI_JOB_NAME"
    paths:
      - _bench/html/**/*.v.html
      - _bench/logs
    when: always
    expire_in: 2 months
